/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2021, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 2.0.3 (js 20210628)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DBR JS: https://www.dynamsoft.com/barcode-reader/sdk-javascript/
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).Dynamsoft=e.Dynamsoft||{},e.Dynamsoft.DCE={}))}(this,(function(e){"use strict";function t(e,t,i,s){return new(i||(i=Promise))((function(o,n){function r(e){try{h(s.next(e))}catch(e){n(e)}}function a(e){try{h(s.throw(e))}catch(e){n(e)}}function h(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}h((s=s.apply(e,t||[])).next())}))}const i=!!("object"==typeof global&&global.process&&global.process.release&&global.process.release.name&&"undefined"==typeof HTMLCanvasElement),s=!i&&"undefined"==typeof self;class o{constructor(){this._canvasMaxWH="iPhone"==o.browserInfo.OS||"Android"==o.browserInfo.OS?2048:4096,this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._singleFrameModeIpt=()=>{let e=document.createElement("input");return e.setAttribute("type","file"),e.setAttribute("accept","image/*"),e.setAttribute("capture",""),e.addEventListener("change",(()=>t(this,void 0,void 0,(function*(){let t=e.files[0];e.value="",this.onSingleFrameAcquired(t)})))),e},this._clickIptSingleFrameMode=()=>{this._singleFrameModeIpt().click()},this.styleEls=[],this.bSaveOriCanvas=!0,this.maxVideoCvsLength=3,this.videoCvses=[],this.videoGlCvs=null,this.videoGl=null,this.glImgData=null,this._onCameraSelChange=()=>{this.play(this._selCam.value).then((()=>{this._isOpen||this.stop()}))},this._onResolutionSelChange=()=>{let e,t;if(this._selRsl&&-1!=this._selRsl.selectedIndex){let i=this._selRsl.options[this._selRsl.selectedIndex];e=i.getAttribute("data-width"),t=i.getAttribute("data-height")}this.play(void 0,e,t).then((()=>{this._isOpen||this.stop()}))},this._onCloseBtnClick=()=>{this.close()},this._isOpen=!1,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{"visible"===document.visibilityState?this._vc_bPlayingVideoBeforeHide&&("Firefox"==o.browserInfo.browser?this.play():this._video.play(),this._vc_bPlayingVideoBeforeHide=!1):this._video&&!this._video.paused&&(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause())},this._video=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._region=null,this.bChangeRegionIndexManually=!1,this._regionIndex=-1,this._loopInterval=0,this._frameQueueMaxLength=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._bStoppedByPause=!1,this.alwaysRefreshBuffer=!0,this._bufferRefreshInterval=0,this.bDestroyed=!1}static getVersion(){return this._version}static detectEnvironment(){return t(this,void 0,void 0,(function*(){let e={wasm:"undefined"!=typeof WebAssembly&&("undefined"==typeof navigator||!(/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&/\(.+\s11_2_([2-6]).*\)/.test(navigator.userAgent))),worker:!!(i?process.version>="v12":"undefined"!=typeof Worker),getUserMedia:!("undefined"==typeof navigator||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia),camera:!1,browser:this.browserInfo.browser,version:this.browserInfo.version,OS:this.browserInfo.OS};if(e.getUserMedia)try{(yield navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e.camera=!0}catch(e){}return e}))}static get engineResourcePath(){return this._engineResourcePath}static set engineResourcePath(e){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");if(null==e&&(e="./"),i||s)o._engineResourcePath=e;else{let t=document.createElement("a");t.href=e,o._engineResourcePath=t.href}this._engineResourcePath.endsWith("/")||(o._engineResourcePath+="/")}static get defaultUIElementURL(){var e;return null===(e=this._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",o.engineResourcePath)}static set defaultUIElementURL(e){this._defaultUIElementURL=e}getUIElement(){return this.UIElement}setUIElement(e){return t(this,void 0,void 0,(function*(){if("string"==typeof e||e instanceof String){if(!e.trim().startsWith("<")){let t=yield fetch(e);if(!t.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+t.statusText);e=yield t.text()}if(!e.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let t=document.createElement("div");t.innerHTML=e;for(let e=0;e<t.childElementCount;++e){let i=t.children[e];i instanceof HTMLStyleElement&&(this.styleEls.push(i),document.head.append(i))}(e=1==t.childElementCount?t.children[0]:t).remove()}this.UIElement=e}))}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(e){if(this._isOpen)throw new Error("`singleFrameMode` is not allowed to change when camera is open.");this._singleFrameMode=e}get ifSaveOriginalImageInACanvas(){return this.bSaveOriCanvas}set ifSaveOriginalImageInACanvas(e){this.bSaveOriCanvas=e}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");let e=[this.UIElement],t=this.UIElement.children;for(let i of t)e.push(i);for(let t=0;t<e.length;++t)for(let i of e[t].children)e.push(i);let i=null;for(let t of e)!this._video&&t.classList.contains("dce-video")?(this._video=t,this._video.setAttribute("playsinline","true")):!this._bgLoading&&t.classList.contains("dce-bg-loading")?this._bgLoading=t:!this._bgCamera&&t.classList.contains("dce-bg-camera")?this._bgCamera=t:!this._selCam&&t.classList.contains("dce-sel-camera")?this._selCam=t:!this._selRsl&&t.classList.contains("dce-sel-resolution")?(this._selRsl=t,this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">ask 1920 x 1080</option>','<option data-width="1280" data-height="720">ask 1280 x 720</option>','<option data-width="640" data-height="480">ask 640 x 480</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&t.classList.contains("dce-opt-gotResolution")?this._optGotRsl=t:!this._btnClose&&t.classList.contains("dce-btn-close")?this._btnClose=t:!this._video&&t.classList.contains("dce-existingVideo")?(this._video=t,this._video.setAttribute("playsinline","true")):!i&&t.tagName&&"video"==t.tagName.toLowerCase()&&(i=t);if(!this._video&&i&&(this._video=i),this.singleFrameMode?this._video&&(this._video.addEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="pointer",this._video.setAttribute("title","Take a photo")):this._bgLoading&&(this._bgLoading.style.display=""),this.singleFrameMode?(this._video&&(this._video.addEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="pointer",this._video.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="")):this._bgLoading&&(this._bgLoading.style.display=""),this._selCam&&this._selCam.addEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.addEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),!this._video)throw this._unbindUI(),Error("Can not find HTMLVideoElement with class `dce-video`");this._isOpen=!0}_unbindUI(){this.singleFrameMode?(this._video&&(this._video.removeEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="",this._video.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this._video=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._isOpen=!1}_assertOpen(){if(!this._isOpen)throw Error("The camera is not open.")}get video(){return this._video}set region(e){this._region=e,this._bFetchingLoopStarted&&(this._regionIndex=-1,this._fetchingLoop(!1))}get region(){return this._region}set regionIndex(e){this.bChangeRegionIndexManually&&(this._region instanceof Array&&this._region.length>e?this._regionIndex=e:this._regionIndex=0)}get regionIndex(){return this._regionIndex}set loopInterval(e){e>=0&&(this._loopInterval=e),this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){return this._loopInterval}set frameQueueMaxLength(e){for(this._frameQueueMaxLength=e;this._frameQueue&&this._frameQueue.length>this._frameQueueMaxLength;)this._frameQueue.shift()}get frameQueueMaxLength(){return this._frameQueueMaxLength}get frameQueue(){return JSON.parse(JSON.stringify(this._frameQueue))}set bufferRefreshInterval(e){this._bufferRefreshInterval=e}get bufferRefreshInterval(){return this._bufferRefreshInterval}isContextDestroyed(){return this.bDestroyed}static createInstance(e){return t(this,void 0,void 0,(function*(){if(i)throw new Error("`CameraEnhancer` is not supported in Node.js.");let t=new o;("string"==typeof e||e instanceof String)&&(e=JSON.parse(e));for(let i in e)t[i]=e[i];return yield t.setUIElement(this.defaultUIElementURL),this._hasEngineResourceLoaded=!0,document.addEventListener("visibilitychange",t._ev_documentHideEvent),t}))}play(e,i,s){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this._video&&this.videoSrc){yield new Promise(((e,i)=>{this._video.onloadedmetadata=()=>t(this,void 0,void 0,(function*(){this._video.onloadedmetadata=null,yield this._video.play(),e()})),"string"==typeof this.videoSrc||this.videoSrc instanceof String?this._video.src=this.videoSrc:this._video.srcObject=this.videoSrc,setTimeout((()=>i(new Error("Failed to play video. Timeout."))),4e3)}));let e={width:this._video.videoWidth,height:this._video.videoHeight};return this.onPlayed&&setTimeout((()=>{this.onPlayed(e)}),0),e}if(this.singleFrameMode)return this._clickIptSingleFrameMode(),{width:0,height:0};const n=++this.iPlayRound;return this.promisePlay&&(yield this.promisePlay,n<this.iPlayRound)?{width:this._video.videoWidth,height:this._video.videoHeight}:(this.promisePlay=(()=>t(this,void 0,void 0,(function*(){var n;try{this._video&&this._video.srcObject&&this.stop(),o._onLog&&o._onLog("DCE: ======before video========"),yield this.getAllCameras();let r=()=>{if(this.bDestroyed)throw l&&l.getTracks().forEach((e=>{e.stop()})),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null,new Error("The CameraEnhancer instance has been destroyed.")};const a=JSON.parse(JSON.stringify(this.videoSettings));let h;"boolean"==typeof a.video&&(a.video={}),i&&(a.video.width={ideal:i}),s&&(a.video.height={ideal:s});const d=["rear","back","rück","arrière","trasera","trás","traseira","posteriore","后面","後面","背面","后置","後置","背置","задней","الخلفية","후","arka","achterzijde","หลัง","baksidan","bagside","sau","bak","tylny","takakamera","belakang","אחורית","πίσω","spate","hátsó","zadní","darrere","zadná","задня","stražnja","belakang","बैक"];let l,g=()=>{for(let e of this._allCameras){let t=e.label.toLowerCase();if(t&&d.some((e=>-1!=t.indexOf(e)))&&/\b0(\b)?/.test(t)){delete a.video.facingMode,a.video.deviceId={ideal:e.deviceId};break}}a.video.deviceId||-1==["Android","HarmonyOS"].indexOf(o.browserInfo.OS)||(delete a.video.facingMode,a.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})};if(e)delete a.video.facingMode,a.video.deviceId={exact:e},this._lastDeviceId=e;else if(a.video.deviceId);else if(this._lastDeviceId)delete a.video.facingMode,a.video.deviceId={exact:this._lastDeviceId};else if(a.video.facingMode){let e=a.video.facingMode;e instanceof Array&&e.length&&(e=e[0]),e=e.exact||e.ideal||e,"environment"===e&&(h=!!a.video.facingMode,g())}o._onLog&&o._onLog("DCE: ======try getUserMedia========");let u,c=[0,500],_=null,v=null,f=e=>t(this,void 0,void 0,(function*(){for(let t of c){r(),t&&(yield new Promise((e=>setTimeout(e,t)))),r();{const t=e.video.deviceId;v=t?t.exact||t.ideal||t:null}try{o._onLog&&o._onLog("DCE: ask "+JSON.stringify(e)),l=yield navigator.mediaDevices.getUserMedia(e);break}catch(e){_=e,o._onLog&&o._onLog("DCE: "+e.message||e)}}}));if(yield f(a),!l){if(o._onLog&&o._onLog("DCE: ======try getUserMedia again========"),u=JSON.parse(JSON.stringify(a)),"object"==typeof u.video){"iPhone"==o.browserInfo.OS?(i>=1280||s>=1280?u.video.width=1280:i>=640||s>=640?u.video.width=640:(i<640||s<640)&&(u.video.width=320),delete u.video.height):h&&!a.video.deviceId?(delete u.video.facingMode,this._allCameras.length&&(u.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):u.video=!0}o._onLog&&o._onLog("DCE: "+u),yield f(u)}if(l||(c=[1e3,2e3],yield f(a)),l||(yield f(u)),!l)throw _;const m=()=>{const e=l.getVideoTracks();let t,i;if(e.length&&(t=this._videoTrack=e[0]),this._video&&t){if(t.label)for(let e of this._allCameras)if(t.label==e.label){e._checked=!0,i=e,this._lastDeviceId=e.deviceId;break}if(!i&&v)for(let e of this._allCameras)if(v==e.deviceId){t.label&&(e._checked=!0,e.label=t.label),i=e,this._lastDeviceId=e.deviceId;break}}this._currentCamera=i};if(yield this.getAllCameras(),r(),h){m(),g();let e=a.video.deviceId;e&&(e=e.exact||e.ideal||e);let t=null===(n=this._currentCamera)||void 0===n?void 0:n.deviceId;!e||t&&e==t||(l.getTracks().forEach((e=>{e.stop()})),c=[0,500,1e3,2e3],yield f(a))}r();const p=()=>t(this,void 0,void 0,(function*(){o._onLog&&o._onLog("======play video========"),yield new Promise(((e,i)=>{this._video.onloadedmetadata=()=>t(this,void 0,void 0,(function*(){this._video.onloadedmetadata=null,yield this._video.play(),e()})),this._video.srcObject=l,setTimeout((()=>i(new Error("Failed to play video. Timeout."))),4e3)}))}));yield p(),o._onLog&&o._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const y="got "+this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=y,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),o._onLog&&o._onLog("DCE: "+y),m(),r(),this._renderSelCameraInfo();let b={width:this._video.videoWidth,height:this._video.videoHeight};return this.onPlayed&&setTimeout((()=>{this.onPlayed(b)}),0),this.promisePlay=null,b}catch(e){throw this.promisePlay=null,e}})))(),yield this.promisePlay)}))}resume(){return t(this,void 0,void 0,(function*(){yield this.play(),this._bStoppedByPause&&(this._bStoppedByPause=!1,this.startFetchingLoop())}))}pause(){this._video&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._bStoppedByPause=!0)}close(){return t(this,void 0,void 0,(function*(){this.stop(),this._unbindUI(),this.UIElement.style.display="none",this.stopFetchingLoop()}))}open(){return t(this,void 0,void 0,(function*(){return this._bindUI(),this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),"none"==this.UIElement.style.display&&(this.UIElement.style.display=""),yield this.play()}))}stop(){this._video&&this._video.srcObject&&(o._onLog&&o._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach((e=>{e.stop()})),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this._video.classList.contains("dce-existingVideo")&&(o._onLog&&o._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0}getAllCameras(){return t(this,void 0,void 0,(function*(){const e=yield navigator.mediaDevices.enumerateDevices(),t=[],i=[];if(this._allCameras)for(let e of this._allCameras)e._checked&&i.push(e);for(let s=0;s<e.length;s++){let o,n=e[s];if("videoinput"==n.kind){for(let e of i)n.deviceId==e.deviceId&&(o=e);o||(o={},o.deviceId=n.deviceId,o.label=n.label?n.label:"camera "+s),t.push(o)}}return this._allCameras=t,o._onLog&&o._onLog("DCE: "+JSON.stringify(this._allCameras)),Promise.resolve(t)}))}_renderSelCameraInfo(){if(this._selCam&&(this._selCam.innerHTML=""),this._selCam){let e;for(let t of this._allCameras){let i=document.createElement("option");i.value=t.deviceId,i.innerText=t.label,this._selCam.append(i),t.deviceId&&this._currentCamera&&this._currentCamera.deviceId==t.deviceId&&(e=i)}this._selCam.value=e?e.value:""}}getSelectedCamera(){return t(this,void 0,void 0,(function*(){return this._currentCamera}))}selectCamera(e){return t(this,void 0,void 0,(function*(){return yield this.play(e.deviceId||e)}))}getResolution(){return this._isOpen?[this._video.videoWidth,this._video.videoHeight]:null}setResolution(e,i){return t(this,void 0,void 0,(function*(){let t,s;return this._isOpen?(e instanceof Array?(t=e[0],s=e[1]):(t=e,s=i),yield this.play(null,t,s)):yield Promise.reject(new Error("The camera is not open."))}))}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(e){return this.videoSettings=JSON.parse(JSON.stringify(e)),this._lastDeviceId=null,this._isOpen?this.play():Promise.resolve()}isOpen(){return this._isOpen}getCapabilities(){return this._assertOpen(),this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){return this._assertOpen(),this._videoTrack.getSettings()}getConstraints(){return this._assertOpen(),this._videoTrack.getConstraints()}applyConstraints(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),!this._videoTrack.applyConstraints)throw Error("Not supported.");return yield this._videoTrack.applyConstraints(e)}))}turnOnTorch(){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")}))}turnOffTorch(){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")}))}setColorTemperature(e){return t(this,void 0,void 0,(function*(){this._assertOpen();let t=this.getCapabilities().colorTemperature;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({advanced:[{colorTemperature:e}]})}))}setExposureCompensation(e){return t(this,void 0,void 0,(function*(){this._assertOpen();let t=this.getCapabilities().exposureCompensation;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({advanced:[{exposureCompensation:e}]})}))}setZoom(e){return t(this,void 0,void 0,(function*(){this._assertOpen();let t=this.getCapabilities().zoom;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({advanced:[{zoom:e}]})}))}setFrameRate(e){return t(this,void 0,void 0,(function*(){this._assertOpen();let t=this.getCapabilities().frameRate;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:e})}))}getFrameRate(){return this.getCameraSettings().frameRate}getFrame(e){if(this.bDestroyed)throw Error("The DCE instance has been destroyed.");this._assertOpen(),o._onLog&&o._onLog("DCE: getFrame(region?)");const t=Date.now(),i=this._video.videoWidth,s=this._video.videoHeight,n=Math.max(i,s);let r,a;if(n>this._canvasMaxWH){let e=this._canvasMaxWH/n;r=Math.round(i*e),a=Math.round(s*e)}else r=i,a=s;let h=0,d=0,l=i,g=s,u=i,c=s;if(e){let t,o,n,_;e.regionMeasuredByPercentage?(t=e.regionLeft*r/100,o=e.regionTop*a/100,n=e.regionRight*r/100,_=e.regionBottom*a/100):(t=e.regionLeft,o=e.regionTop,n=e.regionRight,_=e.regionBottom),u=n-t,l=Math.round(u/r*i),c=_-o,g=Math.round(c/a*s),h=Math.round(t/r*i),d=Math.round(o/a*s)}let _=0==h&&0==d&&i==l&&s==g&&i==u&&s==c;if(!this.bSaveOriCanvas&&_){this.videoGlCvs||(this.videoGlCvs=globalThis.OffscreenCanvas?new OffscreenCanvas(u,c):document.createElement("canvas"));const e=this.videoGlCvs;e.width==u&&e.height==c||(e.height=c,e.width=u,this.videoGl&&this.videoGl.viewport(0,0,u,c));const i=this.videoGl||e.getContext("webgl",{alpha:!1,antialias:!1,depth:!1,stencil:!1,preserveDrawingBuffer:!0})||e.getContext("experimental-webgl",{alpha:!1,antialias:!1,depth:!1,stencil:!1,preserveDrawingBuffer:!0});if(!this.videoGl){this.videoGl=i;const e=i.createShader(i.VERTEX_SHADER);i.shaderSource(e,"\nattribute vec4 a_position;\nattribute vec2 a_uv;\n\nvarying vec2 v_uv;\n\nvoid main() {\n    gl_Position = a_position;\n    v_uv = a_uv;\n}\n"),i.compileShader(e),i.getShaderParameter(e,i.COMPILE_STATUS)||console.error("An error occurred compiling the shaders: "+i.getShaderInfoLog(e));const t=i.createShader(i.FRAGMENT_SHADER);i.shaderSource(t,"\nprecision lowp float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n    vec4 sample =  texture2D(u_texture, v_uv);\n    float grey = 0.299 * sample.r + 0.587 * sample.g + 0.114 * sample.b;\n    gl_FragColor = vec4(grey, 0.0, 0.0, 1.0);\n}\n"),i.compileShader(t),i.getShaderParameter(t,i.COMPILE_STATUS)||console.error("An error occurred compiling the shaders: "+i.getShaderInfoLog(t));const s=i.createProgram();i.attachShader(s,e),i.attachShader(s,t),i.linkProgram(s),i.getProgramParameter(s,i.LINK_STATUS)||console.error("Unable to initialize the shader program: "+i.getProgramInfoLog(s)),i.useProgram(s),i.bindBuffer(i.ARRAY_BUFFER,i.createBuffer()),i.bufferData(i.ARRAY_BUFFER,new Float32Array([-1,1,0,1,1,1,1,1,-1,-1,0,0,1,-1,1,0]),i.STATIC_DRAW);const o=i.getAttribLocation(s,"a_position");i.enableVertexAttribArray(o),i.vertexAttribPointer(o,2,i.FLOAT,!1,16,0);const n=i.getAttribLocation(s,"a_uv");i.enableVertexAttribArray(n),i.vertexAttribPointer(n,2,i.FLOAT,!1,16,8),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,i.createTexture()),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.uniform1i(i.getUniformLocation(s,"u_texture"),0)}(!this.glImgData||this.glImgData.length<u*c*4)&&(this.glImgData=new Uint8Array(u*c*4)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this._video);let s=o._onLog?Date.now():0;i.drawArrays(i.TRIANGLE_STRIP,0,4),o._onLog&&o._onLog("DCE: Grey cost: "+(Date.now()-s));const n=this.glImgData;i.readPixels(0,0,i.drawingBufferWidth,i.drawingBufferHeight,i.RGBA,i.UNSIGNED_BYTE,n);let r=o._onLog?Date.now():0,a=new Uint8Array(new Uint32Array(n.buffer));o._onLog&&o._onLog("DCE: Extract grey cost: "+(Date.now()-r));const h=Date.now();return{canvas:null,data:a,region:null,sx:0,sy:0,width:u,height:c,timeSpent:h-t,timeStamp:h}}{let i=null;if(this.bSaveOriCanvas)i=document.createElement("canvas"),i.width=u,i.height=c,i.dbrCtx2d=i.getContext("2d");else{for(let e of this.videoCvses)if(e.width==u&&e.height==c){i=e;break}i||(globalThis.OffscreenCanvas?i=new OffscreenCanvas(u,c):(i=document.createElement("canvas"),i.width=u,i.height=c),i.dbrCtx2d=i.getContext("2d"),this.videoCvses.length>=this.maxVideoCvsLength&&(this.videoCvses=this.videoCvses.slice(1)),this.videoCvses.push(i))}const s=i.dbrCtx2d;_?s.drawImage(this._video,0,0):s.drawImage(this._video,h,d,l,g,0,0,u,c);let o=i.dbrCtx2d||i.getContext("2d");if(0===i.width||0===i.height)return null;let n=o.getImageData(0,0,i.width,i.height).data;const r=Date.now();return{data:n,canvas:i,region:e,sx:h,sy:d,width:l,height:g,timeSpent:r-t,timeStamp:r}}}getCurrentRegion(){let e;if(this._region)if(this._region instanceof Array){if(this.bChangeRegionIndexManually){if(this._regionIndex>=this._region.length)throw new Error("the 'regionIndex' should be less than the length of region array.")}else++this._regionIndex>=this._region.length&&(this._regionIndex=0);e=this._region[this._regionIndex]}else e=this._region;else e=null;return e}_fetchingLoop(e){if(this.bDestroyed)return void this.stopFetchingLoop();if(!this._isOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();if(this._video.paused)return o._onLog&&o._onLog("DCE: Video is paused. Ask in 1s."),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),void(this._frameLoopTimeoutId=setTimeout((()=>{this._fetchingLoop(!0)}),1e3));const t=()=>{o._onLog&&o._onLog("DCE: start fetching a frame: "+Date.now());let e=this.getCurrentRegion(),t=this.getFrame(e);this._frameQueue&&this._frameQueue.length>=this._frameQueueMaxLength&&this._frameQueue.shift(),this._frameQueue.push(t),o._onLog&&o._onLog("DCE: finish fetching a frame: "+Date.now())},i=()=>{this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._bufferRefreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout((()=>{this.bDestroyed?this.stopFetchingLoop():this._isOpen&&this.isFetchingLoopStarted()?this._video.paused?this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId):(o._onLog&&o._onLog("DCE: second timeout executes: "+Date.now()),t(),i()):this.stopFetchingLoop()}),this._bufferRefreshInterval))};e&&(this._frameQueue.length<this._frameQueueMaxLength?(t(),i()):this.alwaysRefreshBuffer&&t()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout((()=>{this._fetchingLoop(!0)}),this._loopInterval)}startFetchingLoop(){if(this.bDestroyed)throw Error("The DCE instance has been destroyed.");if(this._assertOpen(),this._video.paused)throw Error("The video is paused.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,o._onLog&&o._onLog("start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(o._onLog&&o._onLog("stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1)}getFrameFromBuffer(e){return this._frameQueue&&this._frameQueue.length?e?e<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(e,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.shift()):null}getQueueLength(){return this._frameQueue.length}}o._jsVersion="2.0.3",o._jsEditVersion="20210628",o._version="JS "+o._jsVersion+"."+o._jsEditVersion,o.browserInfo=function(){if(!i&&!s){var e={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"unknownVersion",this.OS=this.searchString(this.dataOS)||"unknownOS","Linux"==this.OS&&-1!=navigator.userAgent.indexOf("Windows NT")&&(this.OS="HarmonyOS")},searchString:function(e){for(var t=0;t<e.length;t++){var i=e[t].string,s=e[t].prop;if(this.versionSearchString=e[t].versionSearch||e[t].identity,i){if(-1!=i.indexOf(e[t].subString))return e[t].identity}else if(s)return e[t].identity}},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);if(-1!=t)return parseFloat(e.substring(t+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Edge",identity:"Edge"},{string:navigator.userAgent,subString:"OPR",identity:"OPR"},{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:navigator.userAgent,subString:"HarmonyOS",identity:"HarmonyOS"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone"},{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};return e.init(),{browser:e.browser,version:e.version,OS:e.OS}}if(s)return{browser:"ssr",version:0,OS:"ssr"}}(),o._hasEngineResourceLoaded=!1,o._engineResourcePath=(()=>{if(i)return"";if(!s&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})(),o._defaultUIElementURL="@engineResourcePath/dce.ui.html";class n{static get browserInfo(){return o.browserInfo}static getVersion(){return o.getVersion()}static detectEnvironment(){return o.detectEnvironment()}static get engineResourcePath(){return o.engineResourcePath}static set engineResourcePath(e){o.engineResourcePath=e}static get _onLog(){return o._onLog}static set _onLog(e){o._onLog=e}}n.CameraEnhancer=o,e.CameraEnhancer=o,e.DCE=n,e.default=n,Object.defineProperty(e,"__esModule",{value:!0})}));
